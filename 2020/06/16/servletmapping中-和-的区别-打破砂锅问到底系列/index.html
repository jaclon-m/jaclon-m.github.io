<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>servletmapping中/和/*的区别--打破砂锅问到底系列 - Jacklon&#039;s Blog</title><meta description="前言在JavaWeb的学习中，我们都知道，在配置dispatchServletMapping的时候，需要配置的路径&amp;#x2F;,而不是&amp;#x2F;*。&amp;#x2F;*会拦截所有请求，包括jsp请求。为什么呢？这个时候一般会探究到web.xml文件的配置，其中defaultServlet的url是&amp;#x2F;,是web容器（这里特指tomcat）默认的请求处理器，我们自己配置&amp;#x2F;覆盖了这个默认的请求处理器，这个时候就会调用我们的dispatc"><meta property="og:type" content="blog"><meta property="og:title" content="servletmapping中/和/*的区别--打破砂锅问到底系列"><meta property="og:url" content="http://59.110.153.50/2020/06/16/servletmapping%E4%B8%AD-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB-%E6%89%93%E7%A0%B4%E7%A0%82%E9%94%85%E9%97%AE%E5%88%B0%E5%BA%95%E7%B3%BB%E5%88%97/"><meta property="og:site_name" content="Jacklon&#039;s Blog"><meta property="og:description" content="前言在JavaWeb的学习中，我们都知道，在配置dispatchServletMapping的时候，需要配置的路径&amp;#x2F;,而不是&amp;#x2F;*。&amp;#x2F;*会拦截所有请求，包括jsp请求。为什么呢？这个时候一般会探究到web.xml文件的配置，其中defaultServlet的url是&amp;#x2F;,是web容器（这里特指tomcat）默认的请求处理器，我们自己配置&amp;#x2F;覆盖了这个默认的请求处理器，这个时候就会调用我们的dispatc"><meta property="og:image" content="http://59.110.153.50/img/og_image.png"><meta property="article:published_time" content="2020-06-15T16:22:08.000Z"><meta property="article:modified_time" content="2020-06-15T16:24:02.179Z"><meta property="article:author" content="Jacklon"><meta property="article:tag" content="Web容器"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://59.110.153.50/2020/06/16/servletmapping%E4%B8%AD-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB-%E6%89%93%E7%A0%B4%E7%A0%82%E9%94%85%E9%97%AE%E5%88%B0%E5%BA%95%E7%B3%BB%E5%88%97/"},"headline":"Jacklon's Blog","image":["http://59.110.153.50/img/og_image.png"],"datePublished":"2020-06-15T16:22:08.000Z","dateModified":"2020-06-15T16:24:02.179Z","author":{"@type":"Person","name":"Jacklon"},"description":"前言在JavaWeb的学习中，我们都知道，在配置dispatchServletMapping的时候，需要配置的路径&#x2F;,而不是&#x2F;*。&#x2F;*会拦截所有请求，包括jsp请求。为什么呢？这个时候一般会探究到web.xml文件的配置，其中defaultServlet的url是&#x2F;,是web容器（这里特指tomcat）默认的请求处理器，我们自己配置&#x2F;覆盖了这个默认的请求处理器，这个时候就会调用我们的dispatc"}</script><link rel="canonical" href="http://59.110.153.50/2020/06/16/servletmapping%E4%B8%AD-%E5%92%8C-%E7%9A%84%E5%8C%BA%E5%88%AB-%E6%89%93%E7%A0%B4%E7%A0%82%E9%94%85%E9%97%AE%E5%88%B0%E5%BA%95%E7%B3%BB%E5%88%97/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?65d4748cd6417633e46d97986b1808cf";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jacklon&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/jaclon-m"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catálogo" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Buscar" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-06-15T16:22:08.000Z" title="2020-06-15T16:22:08.000Z">2020-06-16</time><span class="level-item"><a class="link-muted" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><span> / </span><a class="link-muted" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/Web%E5%AE%B9%E5%99%A8/">Web容器</a></span><span class="level-item">11 minutes leer (Acerca de 1619 palabras)</span></div></div><h1 class="title is-3 is-size-4-mobile">servletmapping中/和/*的区别--打破砂锅问到底系列</h1><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在JavaWeb的学习中，我们都知道，在配置dispatchServletMapping的时候，需要配置的路径<code>/</code>,而不是<code>/*</code>。<code>/*</code>会拦截所有请求，包括jsp请求。<br>为什么呢？<br>这个时候一般会探究到web.xml文件的配置，其中<code>defaultServlet</code>的url是<code>/</code>,是web容器（这里特指tomcat）默认的请求处理器，我们自己配置<code>/</code>覆盖了这个默认的请求处理器，这个时候就会调用我们的<code>dispatcherServlet</code>（即一般的springmvc的时候）。<br>还有一个jsp相关的servlet配置，处理的是jsp请求，即<code>*.jsp</code>。我们没有覆盖这个servlet，所以jsp请求还是由web容器自己处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- The mapping for the default servlet --&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;default&lt;&#x2F;servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;&#x2F;&lt;&#x2F;url-pattern&gt;</span><br><span class="line">&lt;&#x2F;servlet-mapping&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- The mappings for the JSP servlet --&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;jsp&lt;&#x2F;servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;*.jsp&lt;&#x2F;url-pattern&gt;</span><br><span class="line">    &lt;url-pattern&gt;*.jspx&lt;&#x2F;url-pattern&gt;</span><br><span class="line">&lt;&#x2F;servlet-mapping&gt;</span><br></pre></td></tr></table></figure>
<p>解释一般到这里就戛然而止了，不过依然没有解决我们的问题，<code>/</code>和<code>/*</code>都是匹配所有路径，那为什么<code>/</code>就不会覆盖了呢？</p>
<a id="more"></a>

<h2 id="砂锅"><a href="#砂锅" class="headerlink" title="砂锅"></a>砂锅</h2><p>本着这个问题，网上搜了好一阵，终于找到一篇解释正确的博文: <a href="https://www.cnblogs.com/canger/p/6084846.html">servlet的url-pattern匹配规则</a>.<br>主要讲serlet的四中匹配方式和顺序：精确匹配》路径匹配》扩展名匹配》缺省匹配。而<code>/*</code>属于路径匹配，当我们这样写的时候，它的顺序在jsp的扩展名匹配（如上面代码所示，<code>*.jsp</code>,<code>*.jspx</code>）前面的，所以会覆盖。而<code>/</code>属于缺省匹配，顺序在jsp扩展名匹配后面，所以不会覆盖。</p>
<h2 id="底"><a href="#底" class="headerlink" title="底"></a>底</h2><p>继续这个问题，话是这么说，但是还是不放心怎么办？怎么证明你说的是对的？<br>想直接从源码找到答案，奈何鄙人实力有限没找到。于是又费劲找了一篇博文，里面从源码层面印证了这个问题。<br><a href="https://www.jianshu.com/p/bcf8743f156f">Tomcat Url 映射源码学习</a><br>文章有点长，不想看的话可以直接看结论：</p>
<p>一是tomcat在初始化的时候对不同url放入了不同的wrapper中了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">    &#x2F;&#x2F; 调用该addMapping的方法在StandardContext的addServletMapping方法内</span><br><span class="line">    &#x2F;&#x2F; fireContainerEvent(&quot;addServletMapping&quot;, decodedPattern);</span><br><span class="line"></span><br><span class="line">   &#125; else if (Wrapper.ADD_MAPPING_EVENT.equals(event.getType())) &#123;</span><br><span class="line">       &#x2F;&#x2F; Handle dynamically adding wrappers</span><br><span class="line">       Wrapper wrapper &#x3D; (Wrapper) event.getSource();</span><br><span class="line">       Context context &#x3D; (Context) wrapper.getParent();</span><br><span class="line">       String contextPath &#x3D; context.getPath();</span><br><span class="line">       if (&quot;&#x2F;&quot;.equals(contextPath)) &#123;</span><br><span class="line">           contextPath &#x3D; &quot;&quot;;</span><br><span class="line">       &#125;</span><br><span class="line">       String version &#x3D; context.getWebappVersion();</span><br><span class="line">       String hostName &#x3D; context.getParent().getName();</span><br><span class="line">       String wrapperName &#x3D; wrapper.getName();</span><br><span class="line">       String mapping &#x3D; (String) event.getData();</span><br><span class="line">       boolean jspWildCard &#x3D; (&quot;jsp&quot;.equals(wrapperName)</span><br><span class="line">               &amp;&amp; mapping.endsWith(&quot;&#x2F;*&quot;));</span><br><span class="line">       mapper.addWrapper(hostName, contextPath, version, mapping, wrapper,</span><br><span class="line">               jspWildCard, context.isResourceOnlyServlet(wrapperName));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; mapper的addwrapper方法</span><br><span class="line">protected void addWrapper(ContextVersion context, String path,</span><br><span class="line">       Wrapper wrapper, boolean jspWildCard, boolean resourceOnly) &#123;</span><br><span class="line"></span><br><span class="line">   synchronized (context) &#123;</span><br><span class="line">       if (path.endsWith(&quot;&#x2F;*&quot;)) &#123;</span><br><span class="line">           &#x2F;&#x2F; Wildcard wrapper</span><br><span class="line">           String name &#x3D; path.substring(0, path.length() - 2);</span><br><span class="line">           MappedWrapper newWrapper &#x3D; new MappedWrapper(name, wrapper,</span><br><span class="line">                   jspWildCard, resourceOnly);</span><br><span class="line">           MappedWrapper[] oldWrappers &#x3D; context.wildcardWrappers;</span><br><span class="line">           MappedWrapper[] newWrappers &#x3D; new MappedWrapper[oldWrappers.length + 1];</span><br><span class="line">           if (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">               context.wildcardWrappers &#x3D; newWrappers;</span><br><span class="line">               int slashCount &#x3D; slashCount(newWrapper.name);</span><br><span class="line">               if (slashCount &gt; context.nesting) &#123;</span><br><span class="line">                   context.nesting &#x3D; slashCount;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else if (path.startsWith(&quot;*.&quot;)) &#123;</span><br><span class="line">           &#x2F;&#x2F; Extension wrapper</span><br><span class="line">           String name &#x3D; path.substring(2);</span><br><span class="line">           MappedWrapper newWrapper &#x3D; new MappedWrapper(name, wrapper,</span><br><span class="line">                   jspWildCard, resourceOnly);</span><br><span class="line">           MappedWrapper[] oldWrappers &#x3D; context.extensionWrappers;</span><br><span class="line">           MappedWrapper[] newWrappers &#x3D;</span><br><span class="line">               new MappedWrapper[oldWrappers.length + 1];</span><br><span class="line">           if (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">               context.extensionWrappers &#x3D; newWrappers;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else if (path.equals(&quot;&#x2F;&quot;)) &#123;</span><br><span class="line">           &#x2F;&#x2F; Default wrapper</span><br><span class="line">           MappedWrapper newWrapper &#x3D; new MappedWrapper(&quot;&quot;, wrapper,</span><br><span class="line">                   jspWildCard, resourceOnly);</span><br><span class="line">           context.defaultWrapper &#x3D; newWrapper;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           &#x2F;&#x2F; Exact wrapper</span><br><span class="line">           final String name;</span><br><span class="line">           if (path.length() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">               &#x2F;&#x2F; Special case for the Context Root mapping which is</span><br><span class="line">               &#x2F;&#x2F; treated as an exact match</span><br><span class="line">               name &#x3D; &quot;&#x2F;&quot;;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               name &#x3D; path;</span><br><span class="line">           &#125;</span><br><span class="line">           MappedWrapper newWrapper &#x3D; new MappedWrapper(name, wrapper,</span><br><span class="line">                   jspWildCard, resourceOnly);</span><br><span class="line">           MappedWrapper[] oldWrappers &#x3D; context.exactWrappers;</span><br><span class="line">           MappedWrapper[] newWrappers &#x3D; new MappedWrapper[oldWrappers.length + 1];</span><br><span class="line">           if (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">               context.exactWrappers &#x3D; newWrappers;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>/* 放在wildcardWrappers中</li>
<li>*. 放在extensionWrappers中</li>
<li>/ 放在defaultWrapper中</li>
<li>其他 放在exactWrappers中</li>
</ul>
<p>二是新来的http请求，需要找到合适的engine、host、context、wrapper进行处理，在接收到新的请求之后，在CoyoteAdapt类中调用map方法,再调用internalMap方法，这个方法中可以为mappingdata设置整个链路的容器（除了wrapper），最后的internalMapWrapper 明确最后的wrapper</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line">………………</span><br><span class="line">………………</span><br><span class="line">&#x2F;&#x2F; 根据URL匹配具体的wrapper规则</span><br><span class="line">private final void internalMapWrapper(ContextVersion contextVersion,</span><br><span class="line">                                     CharChunk path,</span><br><span class="line">                                     MappingData mappingData) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">   int pathOffset &#x3D; path.getOffset();</span><br><span class="line">   int pathEnd &#x3D; path.getEnd();</span><br><span class="line">   boolean noServletPath &#x3D; false;</span><br><span class="line"></span><br><span class="line">   int length &#x3D; contextVersion.path.length();</span><br><span class="line">   if (length &#x3D;&#x3D; (pathEnd - pathOffset)) &#123;</span><br><span class="line">       noServletPath &#x3D; true;</span><br><span class="line">   &#125;</span><br><span class="line">   int servletPath &#x3D; pathOffset + length;</span><br><span class="line">   path.setOffset(servletPath);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Rule 1 -- Exact Match</span><br><span class="line">   MappedWrapper[] exactWrappers &#x3D; contextVersion.exactWrappers;</span><br><span class="line">   internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Rule 2 -- Prefix Match</span><br><span class="line">   boolean checkJspWelcomeFiles &#x3D; false;</span><br><span class="line">   MappedWrapper[] wildcardWrappers &#x3D; contextVersion.wildcardWrappers;</span><br><span class="line">   if (mappingData.wrapper &#x3D;&#x3D; null) &#123;</span><br><span class="line">       internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,</span><br><span class="line">                                  path, mappingData);</span><br><span class="line">       if (mappingData.wrapper !&#x3D; null &amp;&amp; mappingData.jspWildCard) &#123;</span><br><span class="line">           char[] buf &#x3D; path.getBuffer();</span><br><span class="line">           if (buf[pathEnd - 1] &#x3D;&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">               &#x2F;*</span><br><span class="line">                * Path ending in &#39;&#x2F;&#39; was mapped to JSP servlet based on</span><br><span class="line">                * wildcard match (e.g., as specified in url-pattern of a</span><br><span class="line">                * jsp-property-group.</span><br><span class="line">                * Force the context&#39;s welcome files, which are interpreted</span><br><span class="line">                * as JSP files (since they match the url-pattern), to be</span><br><span class="line">                * considered. See Bugzilla 27664.</span><br><span class="line">                *&#x2F;</span><br><span class="line">               mappingData.wrapper &#x3D; null;</span><br><span class="line">               checkJspWelcomeFiles &#x3D; true;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               &#x2F;&#x2F; See Bugzilla 27704</span><br><span class="line">               mappingData.wrapperPath.setChars(buf, path.getStart(),</span><br><span class="line">                                                path.getLength());</span><br><span class="line">               mappingData.pathInfo.recycle();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   if(mappingData.wrapper &#x3D;&#x3D; null &amp;&amp; noServletPath &amp;&amp;</span><br><span class="line">           contextVersion.object.getMapperContextRootRedirectEnabled()) &#123;</span><br><span class="line">       &#x2F;&#x2F; The path is empty, redirect to &quot;&#x2F;&quot;</span><br><span class="line">       path.append(&#39;&#x2F;&#39;);</span><br><span class="line">       pathEnd &#x3D; path.getEnd();</span><br><span class="line">       mappingData.redirectPath.setChars</span><br><span class="line">           (path.getBuffer(), pathOffset, pathEnd - pathOffset);</span><br><span class="line">       path.setEnd(pathEnd - 1);</span><br><span class="line">       return;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Rule 3 -- Extension Match</span><br><span class="line">   MappedWrapper[] extensionWrappers &#x3D; contextVersion.extensionWrappers;</span><br><span class="line">   if (mappingData.wrapper &#x3D;&#x3D; null &amp;&amp; !checkJspWelcomeFiles) &#123;</span><br><span class="line">       internalMapExtensionWrapper(extensionWrappers, path, mappingData,</span><br><span class="line">               true);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Rule 4 -- Welcome resources processing for servlets</span><br><span class="line">   if (mappingData.wrapper &#x3D;&#x3D; null) &#123;</span><br><span class="line">       boolean checkWelcomeFiles &#x3D; checkJspWelcomeFiles;</span><br><span class="line">       if (!checkWelcomeFiles) &#123;</span><br><span class="line">           char[] buf &#x3D; path.getBuffer();</span><br><span class="line">           checkWelcomeFiles &#x3D; (buf[pathEnd - 1] &#x3D;&#x3D; &#39;&#x2F;&#39;);</span><br><span class="line">       &#125;</span><br><span class="line">       if (checkWelcomeFiles) &#123;</span><br><span class="line">           for (int i &#x3D; 0; (i &lt; contextVersion.welcomeResources.length)</span><br><span class="line">                    &amp;&amp; (mappingData.wrapper &#x3D;&#x3D; null); i++) &#123;</span><br><span class="line">               path.setOffset(pathOffset);</span><br><span class="line">               path.setEnd(pathEnd);</span><br><span class="line">               path.append(contextVersion.welcomeResources[i], 0,</span><br><span class="line">                       contextVersion.welcomeResources[i].length());</span><br><span class="line">               path.setOffset(servletPath);</span><br><span class="line"></span><br><span class="line">               &#x2F;&#x2F; Rule 4a -- Welcome resources processing for exact macth</span><br><span class="line">               internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">               &#x2F;&#x2F; Rule 4b -- Welcome resources processing for prefix match</span><br><span class="line">               if (mappingData.wrapper &#x3D;&#x3D; null) &#123;</span><br><span class="line">                   internalMapWildcardWrapper</span><br><span class="line">                       (wildcardWrappers, contextVersion.nesting,</span><br><span class="line">                        path, mappingData);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               &#x2F;&#x2F; Rule 4c -- Welcome resources processing</span><br><span class="line">               &#x2F;&#x2F;            for physical folder</span><br><span class="line">               if (mappingData.wrapper &#x3D;&#x3D; null</span><br><span class="line">                   &amp;&amp; contextVersion.resources !&#x3D; null) &#123;</span><br><span class="line">                   String pathStr &#x3D; path.toString();</span><br><span class="line">                   WebResource file &#x3D;</span><br><span class="line">                           contextVersion.resources.getResource(pathStr);</span><br><span class="line">                   if (file !&#x3D; null &amp;&amp; file.isFile()) &#123;</span><br><span class="line">                       internalMapExtensionWrapper(extensionWrappers, path,</span><br><span class="line">                                                   mappingData, true);</span><br><span class="line">                       if (mappingData.wrapper &#x3D;&#x3D; null</span><br><span class="line">                           &amp;&amp; contextVersion.defaultWrapper !&#x3D; null) &#123;</span><br><span class="line">                           mappingData.wrapper &#x3D;</span><br><span class="line">                               contextVersion.defaultWrapper.object;</span><br><span class="line">                           mappingData.requestPath.setChars</span><br><span class="line">                               (path.getBuffer(), path.getStart(),</span><br><span class="line">                                path.getLength());</span><br><span class="line">                           mappingData.wrapperPath.setChars</span><br><span class="line">                               (path.getBuffer(), path.getStart(),</span><br><span class="line">                                path.getLength());</span><br><span class="line">                           mappingData.requestPath.setString(pathStr);</span><br><span class="line">                           mappingData.wrapperPath.setString(pathStr);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           path.setOffset(servletPath);</span><br><span class="line">           path.setEnd(pathEnd);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;* welcome file processing - take 2</span><br><span class="line">    * Now that we have looked for welcome files with a physical</span><br><span class="line">    * backing, now look for an extension mapping listed</span><br><span class="line">    * but may not have a physical backing to it. This is for</span><br><span class="line">    * the case of index.jsf, index.do, etc.</span><br><span class="line">    * A watered down version of rule 4</span><br><span class="line">    *&#x2F;</span><br><span class="line">   if (mappingData.wrapper &#x3D;&#x3D; null) &#123;</span><br><span class="line">       boolean checkWelcomeFiles &#x3D; checkJspWelcomeFiles;</span><br><span class="line">       if (!checkWelcomeFiles) &#123;</span><br><span class="line">           char[] buf &#x3D; path.getBuffer();</span><br><span class="line">           checkWelcomeFiles &#x3D; (buf[pathEnd - 1] &#x3D;&#x3D; &#39;&#x2F;&#39;);</span><br><span class="line">       &#125;</span><br><span class="line">       if (checkWelcomeFiles) &#123;</span><br><span class="line">           for (int i &#x3D; 0; (i &lt; contextVersion.welcomeResources.length)</span><br><span class="line">                    &amp;&amp; (mappingData.wrapper &#x3D;&#x3D; null); i++) &#123;</span><br><span class="line">               path.setOffset(pathOffset);</span><br><span class="line">               path.setEnd(pathEnd);</span><br><span class="line">               path.append(contextVersion.welcomeResources[i], 0,</span><br><span class="line">                           contextVersion.welcomeResources[i].length());</span><br><span class="line">               path.setOffset(servletPath);</span><br><span class="line">               internalMapExtensionWrapper(extensionWrappers, path,</span><br><span class="line">                                           mappingData, false);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           path.setOffset(servletPath);</span><br><span class="line">           path.setEnd(pathEnd);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Rule 7 -- Default servlet</span><br><span class="line">   if (mappingData.wrapper &#x3D;&#x3D; null &amp;&amp; !checkJspWelcomeFiles) &#123;</span><br><span class="line">       if (contextVersion.defaultWrapper !&#x3D; null) &#123;</span><br><span class="line">           mappingData.wrapper &#x3D; contextVersion.defaultWrapper.object;</span><br><span class="line">           mappingData.requestPath.setChars</span><br><span class="line">               (path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">           mappingData.wrapperPath.setChars</span><br><span class="line">               (path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">           mappingData.matchType &#x3D; MappingMatch.DEFAULT;</span><br><span class="line">       &#125;</span><br><span class="line">       &#x2F;&#x2F; Redirection to a folder</span><br><span class="line">       char[] buf &#x3D; path.getBuffer();</span><br><span class="line">       if (contextVersion.resources !&#x3D; null &amp;&amp; buf[pathEnd -1 ] !&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">           String pathStr &#x3D; path.toString();</span><br><span class="line">           WebResource file;</span><br><span class="line">           &#x2F;&#x2F; Handle context root</span><br><span class="line">           if (pathStr.length() &#x3D;&#x3D; 0) &#123;</span><br><span class="line">               file &#x3D; contextVersion.resources.getResource(&quot;&#x2F;&quot;);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               file &#x3D; contextVersion.resources.getResource(pathStr);</span><br><span class="line">           &#125;</span><br><span class="line">           if (file !&#x3D; null &amp;&amp; file.isDirectory() &amp;&amp;</span><br><span class="line">                   contextVersion.object.getMapperDirectoryRedirectEnabled()) &#123;</span><br><span class="line">               &#x2F;&#x2F; Note: this mutates the path: do not do any processing</span><br><span class="line">               &#x2F;&#x2F; after this (since we set the redirectPath, there</span><br><span class="line">               &#x2F;&#x2F; shouldn&#39;t be any)</span><br><span class="line">               path.setOffset(pathOffset);</span><br><span class="line">               path.append(&#39;&#x2F;&#39;);</span><br><span class="line">               mappingData.redirectPath.setChars</span><br><span class="line">                   (path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               mappingData.requestPath.setString(pathStr);</span><br><span class="line">               mappingData.wrapperPath.setString(pathStr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   path.setOffset(pathOffset);</span><br><span class="line">   path.setEnd(pathEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p>其实这个问题萦绕心间好久了，现在也有点过时了。不过以前一直没有解决，今天终于能完全弄明白，心里还是很愉快的，说明自己还是有一点进步的。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Web%E5%AE%B9%E5%99%A8/">Web容器</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/" alt="Alipay"></span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/06/16/lock%E4%B8%8Esynchronized%E7%9A%84%E5%8C%BA%E5%88%AB-%E8%87%AA%E6%80%BB%E7%BB%93-%E5%BA%95%E5%B1%82/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">lock与synchronized的区别-自总结-底层</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/06/15/hello-world/"><span class="level-item">Hello World</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comentarios</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "vdKGC2peyYNqLJP9zJe3AqHe-gzGzoHsz",
            appKey: "szUoRSxrU2ILylrufEgnWQTw",
            
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-Hans",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://s1.ax1x.com/2020/06/08/thQzdS.th.jpg" alt="Jacklon"></figure><p class="title is-size-4 is-block line-height-inherit">Jacklon</p><p class="is-size-6 is-block">非典型程序员一枚</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Entradas</p><a href="/archives"><p class="title">15</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categorías</p><a href="/categories"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Etiquetas</p><a href="/tags"><p class="title">7</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/jaclon-m" target="_blank" rel="noopener">SEGUIR</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/jaclon-m"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catálogo</h3><ul class="menu-list"><li><a class="is-flex" href="#前言"><span class="mr-2">1</span><span>前言</span></a></li><li><a class="is-flex" href="#砂锅"><span class="mr-2">2</span><span>砂锅</span></a></li><li><a class="is-flex" href="#底"><span class="mr-2">3</span><span>底</span></a></li><li><a class="is-flex" href="#其它"><span class="mr-2">4</span><span>其它</span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jacklon&#039;s Blog" height="28"></a><p class="size-small"><span>&copy; 2020 Jacklon</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/jaclon-m"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-Hans");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://59.110.153.50',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Teclea algo..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Teclea algo...","untitled":"(Untitled)","posts":"Entradas","pages":"Pages","categories":"Categorías","tags":"Etiquetas"});
        });</script></body></html>